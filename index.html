<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>李晓庆社区-SeaTable正式版</title>
    <style>
        :root { --primary: #007AFF; --bg: #f2f2f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 15px; }
        .post-card { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        textarea { width: 100%; min-height: 100px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin: 10px 0; font-size: 16px; }
        .pub-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .msg-item { background: white; border-radius: 12px; padding: 12px; margin-top: 15px; border-left: 5px solid var(--primary); }
    </style>
</head>
<body>

<div class="post-card">
    <input type="text" id="nick" value="李晓庆" style="font-weight:bold; border:none; font-size:18px; outline:none;">
    <textarea id="text" placeholder="输入内容..."></textarea>
    <button id="pubBtn" onclick="submitPost()" class="pub-btn">发布到 SeaTable</button>
</div>
<div id="list" style="margin-top:20px;">正在获取数据...</div>

<script>
    const ST_CONFIG = {
        serverUrl: 'https://cloud.seatable.cn',
        apiToken: '089d8d96364b277f0e76d36e139fb924b1c82149',
        tableName: '记录'
    };

    // 获取授权的统一函数
    async function getAuth() {
        const res = await fetch(`${ST_CONFIG.serverUrl}/api/v2.1/get-base-token/`, {
            headers: { Authorization: `Token ${ST_CONFIG.apiToken}` }
        });
        if (!res.ok) throw new Error("Token权限错误");
        return await res.json();
    }

    // 发布数据
    async function submitPost() {
        const txt = document.getElementById('text').value.trim();
        if (!txt) return alert("请输入内容");
        
        const btn = document.getElementById('pubBtn');
        btn.innerText = "传输中...";
        btn.disabled = true;

        try {
            const auth = await getAuth();
            const response = await fetch(`${ST_CONFIG.serverUrl}/dtable-server/api/v1/dtables/${auth.dtable_uuid}/rows/`, {
                method: 'POST',
                headers: {
                    'Authorization': `Token ${auth.access_token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "table_name": ST_CONFIG.tableName,
                    "row": {
                        "user": document.getElementById('nick').value,
                        "content": txt,
                        "time": new Date().toLocaleString(),
                        "searchDate": new Date().toISOString().split('T')[0]
                    }
                })
            });

            if (response.ok) {
                document.getElementById('text').value = '';
                alert("发布成功！");
                loadData();
            } else {
                alert("SeaTable拒绝接收：检查表名或列名是否正确");
            }
        } catch (e) {
            alert("连接失败！请不要直接双击打开HTML，请使用服务器地址访问。");
        } finally {
            btn.innerText = "发布到 SeaTable";
            btn.disabled = false;
        }
    }

    // 读取数据
    async function loadData() {
        try {
            const auth = await getAuth();
            const res = await fetch(`${ST_CONFIG.serverUrl}/dtable-server/api/v1/dtables/${auth.dtable_uuid}/rows/?table_name=${ST_CONFIG.tableName}`, {
                headers: { 'Authorization': `Token ${auth.access_token}` }
            });
            const data = await res.json();
            document.getElementById('list').innerHTML = (data.rows || []).reverse().map(p => `
                <div class="msg-item">
                    <div style="font-size:12px; color:#999;">${p.user} · ${p.time}</div>
                    <div style="margin-top:8px;">${p.content}</div>
                </div>
            `).join('') || "暂无数据";
        } catch (e) {
            document.getElementById('list').innerHTML = "无法加载数据，请检查网络或CORS限制。";
        }
    }

    window.onload = loadData;
</script>
</body>
</html>
