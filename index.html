<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ææ™“åº†ç¤¾åŒº-æ‰‹æœºå®Œç¾ç¼©æ”¾ç‰ˆ</title>
    <style>
        :root { --primary: #007AFF; --success: #34c759; --danger: #ff3b30; --bg: #f2f2f7; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 80px; }
        
        /* é¡¶éƒ¨æœç´¢ */
        .header-box { position: sticky; top: 0; z-index: 999; background: var(--bg); padding: 5px 0 10px; }
        .search-bar { display: flex; gap: 8px; margin-bottom: 8px; }
        .search-input { flex: 1; padding: 12px; border: none; border-radius: 12px; outline: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .filter-panel { background: white; padding: 10px; border-radius: 12px; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 10px;}
        .date-input { border: 1px solid #eee; padding: 6px; border-radius: 6px; font-size: 12px; flex: 1; }

        /* å‘å¸ƒåŒºåŸŸ */
        .post-card { background: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .user-input { border: none; font-size: 18px; font-weight: bold; width: 100%; outline: none; margin-bottom: 5px; }
        textarea { width: 100%; min-height: 80px; border: none; resize: none; outline: none; font-size: 16px; }

        /* é¢„è§ˆåŒº */
        #preViewBox { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .pre-item { position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; background: #eee; border: 1px solid #ddd; }
        .pre-item img, .pre-item video { width: 100%; height: 100%; object-fit: cover; }
        .del-tag { position: absolute; top: 0; right: 0; background: var(--danger); color: white; padding: 2px 8px; font-size: 14px; z-index: 10; border-bottom-left-radius: 8px; cursor: pointer; }

        .btn-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 15px 0; }
        .f-label { background: #fff; border: 1px solid #ddd; padding: 12px; text-align: center; border-radius: 12px; font-size: 13px; cursor: pointer; }
        .pub-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 15px; font-weight: bold; }

        /* åˆ—è¡¨æ˜¾ç¤º */
        .msg-item { background: white; border-radius: 18px; padding: 15px; margin-bottom: 12px; }
        .list-media { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }
        .list-media img { width: 31.8%; aspect-ratio: 1; object-fit: cover; border-radius: 10px; cursor: pointer; }

        /* --- æ‰‹æœºç«¯å¤§å›¾æŸ¥çœ‹å™¨ä¼˜åŒ– --- */
        #imgViewer { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.98); z-index: 10000; justify-content: center; align-items: center; 
            touch-action: none; overflow: hidden;
        }
        #viewerContent { 
            max-width: 100%; max-height: 100%; object-fit: contain; 
            transition: transform 0.1s ease-out; will-change: transform; 
        }
        .viewer-close { position: absolute; top: 30px; right: 25px; color: white; font-size: 40px; font-weight: bold; z-index: 10001; }
    </style>
</head>
<body>

<div id="imgViewer">
    <span class="viewer-close" onclick="closeViewer()">&times;</span>
    <img id="viewerContent" src="" onclick="event.stopPropagation()">
</div>

<div class="container">
    <div class="header-box">
        <div class="search-bar">
            <input type="text" id="search" class="search-input" placeholder="ğŸ” æœç´¢å†…å®¹..." oninput="doSearch()">
            <button onclick="directExport()" style="border:none; padding:0 10px; border-radius:12px; background:var(--success); color:white; font-size:12px;">å¤‡ä»½HTML</button>
            <button onclick="exportJSON()" style="border:none; padding:0 10px; border-radius:12px; background:var(--primary); color:white; font-size:12px;">å¯¼å‡ºæ•°æ®</button>
            <button onclick="document.getElementById('importFile').click()" style="border:none; padding:0 10px; border-radius:12px; background:#673ab7; color:white; font-size:12px;">å¯¼å…¥æ•°æ®</button>
            <button onclick="clearAll()" style="border:none; padding:0 5px; border-radius:12px; background:var(--danger); color:white; font-size:12px;">æ¸…ç©º</button>
        </div>
        <div class="filter-panel">
            <input type="date" id="dateStart" class="date-input" onchange="doSearch()">
            <span>è‡³</span>
            <input type="date" id="dateEnd" class="date-input" onchange="doSearch()">
            <button onclick="resetSearch()" style="border:none; background:none; color:var(--primary); font-size:12px;">é‡ç½®</button>
        </div>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(this)">
    </div>

    <div class="post-card">
        <input type="text" id="nick" value="ææ™“åº†" class="user-input">
        <textarea id="text" placeholder="æ­¤æ—¶æ­¤åˆ»çš„æƒ³æ³•..."></textarea>
        <div id="preViewBox"></div>
        <div class="btn-group">
            <label class="f-label">ğŸ–¼ï¸ é€‰å›¾<input type="file" accept="image/*" multiple hidden onchange="handleFiles(this, 'imgs')"></label>
            <label class="f-label">ğŸ¬ è§†é¢‘<input type="file" accept="video/*" multiple hidden onchange="handleFiles(this, 'vids')"></label>
            <label class="f-label">ğŸ“„ æ–‡æ¡£<input type="file" multiple hidden onchange="handleFiles(this, 'docs')"></label>
        </div>
        <button onclick="submitPost()" class="pub-btn">ç¡®è®¤å‘å¸ƒ</button>
    </div>

    <div id="list"></div>
</div>

<script>
    let db;
    let queue = { imgs: [], vids: [], docs: [] };
    let allPosts = [];

    // åˆå§‹åŒ–æ•°æ®åº“
    const req = indexedDB.open("20260103", 10);
    req.onupgradeneeded = e => {
        db = e.target.result;
        if (!db.objectStoreNames.contains("posts")) db.createObjectStore("posts", { keyPath: "id", autoIncrement: true });
    };
    req.onsuccess = e => { db = e.target.result; load(); };

    // --- æ ¸å¿ƒæ‰‹åŠ¿ç¼©æ”¾é€»è¾‘ ---
    let scale = 1, lastScale = 1, startDist = 0;
    let posX = 0, posY = 0, startX = 0, startY = 0;
    const vBox = document.getElementById('imgViewer');
    const vImg = document.getElementById('viewerContent');

    function viewImage(src) {
        vImg.src = src;
        scale = 1; posX = 0; posY = 0;
        updateTransform();
        vBox.style.display = 'flex';
    }

    function closeViewer() { vBox.style.display = 'none'; }

    function updateTransform() {
        vImg.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
    }

    vBox.addEventListener('touchstart', e => {
        if (e.touches.length === 2) {
            startDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            lastScale = scale;
        } else if (e.touches.length === 1) {
            startX = e.touches[0].pageX - posX;
            startY = e.touches[0].pageY - posY;
        }
    });

    vBox.addEventListener('touchmove', e => {
        e.preventDefault();
        if (e.touches.length === 2) {
            const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            scale = Math.min(Math.max(1, lastScale * (dist / startDist)), 4);
        } else if (e.touches.length === 1 && scale > 1) {
            posX = e.touches[0].pageX - startX;
            posY = e.touches[0].pageY - startY;
        }
        updateTransform();
    }, { passive: false });

    // --- åŸºç¡€ä¸šåŠ¡é€»è¾‘ ---
    async function handleFiles(input, type) {
        for (let f of Array.from(input.files)) {
            const data = await new Promise(res => {
                const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(f);
            });
            queue[type].push({ id: Date.now() + Math.random(), name: f.name, data });
        }
        input.value = ''; renderQueue();
    }

    function renderQueue() {
        const box = document.getElementById('preViewBox'); box.innerHTML = '';
        queue.imgs.forEach(i => box.appendChild(createPreItem(i, 'imgs', 'img')));
        queue.vids.forEach(v => box.appendChild(createPreItem(v, 'vids', 'video')));
        queue.docs.forEach(d => {
            const div = document.createElement('div');
            div.style="grid-column:span 3; background:#f0f7ff; padding:8px; border-radius:8px; font-size:12px; display:flex; justify-content:space-between; margin-bottom:5px;";
            div.innerHTML = `<span>ğŸ“„ ${d.name}</span><span onclick="removeItem('docs',${d.id})" style="color:red; cursor:pointer">ç§»é™¤</span>`;
            box.appendChild(div);
        });
    }

    function createPreItem(item, type, tag) {
        const div = document.createElement('div'); div.className = 'pre-item';
        const media = document.createElement(tag); media.src = item.data;
        div.innerHTML = `<div class="del-tag" onclick="removeItem('${type}', ${item.id})">Ã—</div>`;
        div.prepend(media); return div;
    }

    function removeItem(type, id) { queue[type] = queue[type].filter(i => i.id !== id); renderQueue(); }

    function submitPost() {
        const txt = document.getElementById('text').value.trim();
        if (!txt && queue.imgs.length === 0 && queue.docs.length === 0 && queue.vids.length === 0) return;
        const now = new Date();
        const tx = db.transaction("posts", "readwrite");
        tx.objectStore("posts").add({
            user: document.getElementById('nick').value,
            content: txt, time: now.toLocaleString(), 
            searchDate: now.toISOString().split('T')[0],
            imgs: [...queue.imgs], vids: [...queue.vids], docs: [...queue.docs]
        });
        tx.oncomplete = () => { 
            document.getElementById('text').value = ''; 
            queue = { imgs: [], vids: [], docs: [] }; 
            renderQueue(); load(); 
        };
    }

    function load() {
        db.transaction("posts").objectStore("posts").getAll().onsuccess = e => {
            allPosts = e.target.result.reverse(); renderList(allPosts);
        };
    }

    function renderList(data) {
        const list = document.getElementById('list'); list.innerHTML = '';
        data.forEach(p => {
            const div = document.createElement('div'); div.className = 'msg-item';
            div.innerHTML = `
                <div style="font-size:11px; color:#999; margin-bottom:8px;"><b>${p.user}</b> Â· ${p.time} <span style="float:right; color:red; cursor:pointer" onclick="drop(${p.id})">åˆ é™¤</span></div>
                <div style="white-space:pre-wrap; font-size:15px; line-height:1.5;">${p.content}</div>
                <div class="list-media">
                    ${p.imgs.map(i => `<img src="${i.data}" onclick="viewImage('${i.data}')">`).join('')}
                </div>
                ${p.vids.map(v => `<video controls src="${v.data}" playsinline style="width:100%; border-radius:10px; margin-top:8px; background:#000;"></video>`).join('')}
                ${p.docs.map(d => `
                    <div style="margin-top:10px; padding:12px; background:#f8f9ff; border-radius:10px; font-size:13px; color:var(--primary); border:1px solid #e1e8ff;" onclick="forceDownload('${d.data}', '${d.name}')">
                        ğŸ“„ ${d.name} <span style="float:right">ä¸‹è½½ â¬‡ï¸</span>
                    </div>
                `).join('')}
            `;
            list.appendChild(div);
        });
    }

    // --- ä¸‹è½½ä¸æœç´¢ä¼˜åŒ– ---
    function forceDownload(base64Data, filename) {
        const a = document.createElement('a');
        a.href = base64Data;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => document.body.removeChild(a), 100);
    }

    function exportJSON() {
        const tx = db.transaction("posts", "readonly");
        tx.objectStore("posts").getAll().onsuccess = e => {
            const blob = new Blob([JSON.stringify(e.target.result)], { type: "application/json" });
            const reader = new FileReader();
            reader.onload = (ev) => {
                const a = document.createElement('a');
                a.href = ev.target.result;
                a.download = `ç¤¾åŒºå¤‡ä»½_${new Date().getTime()}.json`;
                document.body.appendChild(a);
                a.click();
            };
            reader.readAsDataURL(blob);
        };
    }

    function directExport() {
        const html = document.documentElement.outerHTML;
        const blob = new Blob([html], { type: 'text/html' });
        const reader = new FileReader();
        reader.onload = (e) => {
            const a = document.createElement('a');
            a.href = e.target.result;
            a.download = `ç½‘é¡µå¤‡ä»½_${Date.now()}.html`;
            document.body.appendChild(a);
            a.click();
        };
        reader.readAsDataURL(blob);
    }

    async function importJSON(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = JSON.parse(e.target.result);
                const tx = db.transaction("posts", "readwrite");
                data.forEach(item => { if(item.id) delete item.id; tx.objectStore("posts").add(item); });
                tx.oncomplete = () => { alert("å¯¼å…¥æˆåŠŸï¼"); load(); };
            } catch (err) { alert("æ ¼å¼é”™è¯¯ï¼"); }
        };
        reader.readAsText(file);
    }

    function doSearch() {
        const k = document.getElementById('search').value.toLowerCase();
        const s = document.getElementById('dateStart').value;
        const e = document.getElementById('dateEnd').value;
        renderList(allPosts.filter(p => {
            const matchK = (p.content + p.user).toLowerCase().includes(k);
            let matchD = true;
            if (s && p.searchDate < s) matchD = false;
            if (e && p.searchDate > e) matchD = false;
            return matchK && matchD;
        }));
    }

    function resetSearch() {
        document.getElementById('search').value = '';
        document.getElementById('dateStart').value = '';
        document.getElementById('dateEnd').value = '';
        renderList(allPosts);
    }

    function drop(id) { if(confirm("åˆ é™¤ï¼Ÿ")) db.transaction("posts", "readwrite").objectStore("posts").delete(id).onsuccess = load; }
    function clearAll() { if(confirm("æ¸…ç©ºï¼Ÿ")) db.transaction("posts", "readwrite").objectStore("posts").clear().onsuccess = load; }
</script>
</body>
</html>
